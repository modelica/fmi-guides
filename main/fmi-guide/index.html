<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>FMI 3.0 Implementers' Guide</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:30em;padding-right:0}
#toc.toc2{width:30em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}

/* customizations */

body{
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
}

.toc-hidden {
  padding-left: 0 !important;
}

.imageblock {
  text-align: center;
}

.imageblock img {
  display: block;
  margin: auto;
}

.imageblock .title {
  display: inline-block;
  margin: auto;
}

.vertical-text {
	transform: rotate(-90deg) translate(-11em, 0);
	transform-origin: left top 0;
  float: left;
  display: inline-block;
  white-space: nowrap;
  width: 1em;
  height: 11em;
}

/* no alternating row colors */
table tr.even,table tr.alt,table tr:nth-of-type(even) {
  background:none
}

/* use parent text color for captions */
.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
  color: inherit;
}

a {
  text-decoration: none;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
<script>
// hide / show the Table of Contents (TOC)
function toggleTOC() {
  var toc = document.getElementById("toc");
  var body = document.getElementsByTagName("body")[0];

  if (toc.style.display === "none") {
      toc.style.display = "block";
      body.classList.remove("toc-hidden");
  } else {
      toc.style.display = "none";
      body.classList.add("toc-hidden");
  }
}

// toggle the TOC when "t" key is pressed
document.addEventListener('keydown', (event) => {
  if (event.key == 't') {
    toggleTOC();
  }
});
</script>

<!-- Generate a nice TOC -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js"></script>
<!-- We do not need the tocify CSS because the asciidoc CSS already provides most of what we neeed -->

<style>
.tocify-header {
    font-style: italic;
}

.tocify-subheader {
    font-style: normal;
    font-size: 90%;
}

.tocify ul {
    margin: 0;
 }

.tocify-focus {
    color: #7a2518;
    background-color: rgba(0, 0, 0, 0.1);
}

.tocify-focus > a {
    color: #7a2518;
}
</style>

<script type="text/javascript">
    $(function () {
        // Add a new container for the tocify toc into the existing toc so we can re-use its
        // styling
        $("#toc").append("<div id='generated-toc'></div>");
        $("#generated-toc").tocify({
            extendPage: true,
            context: "#content",
            highlightOnScroll: true,
            // don't hide the sections in the TOC
            showAndHide: false,
            hideEffect: "slideUp",
            // Use the IDs that asciidoc already provides so that TOC links and intra-document
            // links are the same. Anything else might confuse users when they create bookmarks.
            hashGenerator: function(text, element) {
                return $(element).attr("id");
            },
            // Smooth scrolling doesn't work properly if we use the asciidoc IDs
            smoothScroll: false,
            // Set to 'none' to use the tocify classes
            theme: "none",
            // Handle book (may contain h1) and article (only h2 deeper)
            selectors: $( "#content" ).has( "h1" ).size() > 0 ? "h1,h2,h3" : "h2,h3,h4",
            ignoreSelector: ".discrete"
        });

        // Switch between static asciidoc toc and dynamic tocify toc based on browser size
        // This is set to match the media selectors in the asciidoc CSS
        // Without this, we keep the dynamic toc even if it is moved from the side to preamble
        // position which will cause odd scrolling behavior
        var handleTocOnResize = function() {
            if ($(document).width() < 768) {
                $("#generated-toc").hide();
                $(".sectlevel0").show();
                $(".sectlevel1").show();
            }
            else {
                $("#generated-toc").show();
                $(".sectlevel0").hide();
                $(".sectlevel1").hide();
            }
        }

        $(window).resize(handleTocOnResize);
        handleTocOnResize();
    });
</script>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center;">
    <img style="display: block; margin: 2em auto; width: 20em;" src="images/Modelica_Association.svg" alt="Modelica Association logo">
    <img style="display: block; margin: 2em auto; width: 20em;" src="images/FMI_logo_horizontal.svg" alt="FMI logo">
    <img style="display: block; margin: 2em auto; width: 20em;" src="images/prostep_logo.svg" alt="prostep ivip logo">
</div>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>FMI 3.0 Implementers' Guide</h1>
<div class="details">
<span id="revnumber">version main-14ba419f8014a00e6b61690b4f3c9a9773431204,</span>
<span id="revdate">2023-11-17</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_general_considerations">2. General Considerations</a>
<ul class="sectlevel2">
<li><a href="#_versions_of_fmi_to_support">2.1. Versions of FMI to support</a></li>
<li><a href="#_support_for_interface_types">2.2. Support for Interface Types</a></li>
<li><a href="#_support_for_optional_features">2.3. Support for Optional Features</a></li>
<li><a href="#_testing">2.4. Testing</a></li>
<li><a href="#_licensing_and_license_handling">2.5. Licensing and License Handling</a></li>
</ul>
</li>
<li><a href="#_packaging_and_code_generationloading">3. Packaging and Code Generation/Loading</a>
<ul class="sectlevel2">
<li><a href="#_zip_archive_structure">3.1. ZIP Archive Structure</a>
<ul class="sectlevel3">
<li><a href="#_pathnames_and_prefixes">3.1.1. Pathnames and Prefixes</a></li>
<li><a href="#_access_to_fmu_package_content">3.1.2. Access to FMU package content</a></li>
</ul>
</li>
<li><a href="#_documentation_and_additional_resources">3.2. Documentation and Additional Resources</a>
<ul class="sectlevel3">
<li><a href="#_icons">3.2.1. Icons</a></li>
<li><a href="#_meta_data">3.2.2. Meta Data</a></li>
<li><a href="#_documentation">3.2.3. Documentation</a></li>
</ul>
</li>
<li><a href="#_support_for_3264bit_variants_of_platforms">3.3. Support for 32&amp;64bit Variants of Platforms</a></li>
<li><a href="#_support_for_multiple_platforms">3.4. Support for Multiple Platforms</a></li>
<li><a href="#_compiler_dependencies">3.5. Compiler Dependencies</a></li>
<li><a href="#_handling_of_fmu_namespaces">3.6. Handling of FMU namespaces</a></li>
<li><a href="#_handling_of_code_dependencies">3.7. Handling of Code Dependencies</a></li>
<li><a href="#_interaction_between_fmu_and_importer">3.8. Interaction between FMU and Importer</a>
<ul class="sectlevel3">
<li><a href="#_global_state">3.8.1. Global State</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_parameter_and_variable_handling">4. Parameter and Variable Handling</a>
<ul class="sectlevel2">
<li><a href="#_support_for_physical_units">4.1. Support for Physical Units</a></li>
<li><a href="#_support_for_minmax_range_information">4.2. Support for Min/Max Range Information</a></li>
<li><a href="#_support_for_structured_naming_convention">4.3. Support for Structured Naming Convention</a></li>
<li><a href="#_selection_of_exported_parametersvariables">4.4. Selection of Exported Parameters/Variables</a></li>
</ul>
</li>
<li><a href="#_simulation">5. Simulation</a>
<ul class="sectlevel2">
<li><a href="#_instantiation">5.1. Instantiation</a></li>
<li><a href="#_initialization">5.2. Initialization</a></li>
<li><a href="#_startup">5.3. Startup</a></li>
<li><a href="#_support_for_solvers">5.4. Support for Solvers</a></li>
<li><a href="#_support_for_mixing_fmus_types">5.5. Support for Mixing FMUs Types</a></li>
<li><a href="#_logging_support">5.6. Logging Support</a></li>
<li><a href="#_handling_of_dependency_information">5.7. Handling of Dependency Information</a>
<ul class="sectlevel3">
<li><a href="#_example_1">5.7.1. Example 1</a></li>
<li><a href="#_example_2">5.7.2. Example 2</a></li>
<li><a href="#_example_3">5.7.3. Example 3</a></li>
<li><a href="#_example_4">5.7.4. Example 4</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_co_simulation_specific_issues">6. Co-Simulation Specific Issues</a>
<ul class="sectlevel2">
<li><a href="#_early_return">6.1. Early Return</a></li>
<li><a href="#_event_handling_in_co_simulation">6.2. Event-Handling in Co-Simulation</a></li>
</ul>
</li>
<li><a href="#_model_exchange_specific_issues">7. Model-Exchange Specific Issues</a>
<ul class="sectlevel2">
<li><a href="#_completed_integrator_step_function">7.1. Completed Integrator Step Function</a></li>
</ul>
</li>
<li><a href="#_scheduled_execution_specific_issues">8. Scheduled-Execution Specific Issues</a>
<ul class="sectlevel2">
<li><a href="#_use_cases_for_scheduled_execution">8.1. Use-cases for Scheduled Execution</a></li>
<li><a href="#_priority_levels_of_clocks">8.2. Priority Levels of Clocks</a></li>
<li><a href="#_handling_of_preemptive_scheduling">8.3. Handling of Preemptive Scheduling</a></li>
</ul>
</li>
<li><a href="#_advanced_features">9. Advanced Features</a>
<ul class="sectlevel2">
<li><a href="#_partial_derivatives">9.1. Partial Derivatives</a>
<ul class="sectlevel3">
<li><a href="#directionDerivatives">9.1.1. Directional Derivatives</a></li>
<li><a href="#adjointDerivatives">9.1.2. Adjoint Derivatives</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_references">References</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The FMI 3.0 Implementers' Guide is a free resource intended to give non-normative recommendations and guidance to implementers of the Functional Mock-up Interface standard version 3.0.
All guidance is based on FMI 3.0 unless otherwise noted or applicable.
This document is a joint publication by the Modelica Association Project FMI and the prostep ivip SmartSE project.
It is continually revised based on implementer and user feedback and input.
All of the content is to be considered non-normative and shall not be considered to supplant any normative statement in the FMI 3.0 standard, or any other standard or layered standard.
<a href="https://github.com/modelica/fmi-guides/releases">Releases</a> and <a href="https://github.com/modelica/fmi-guides/issues">issues</a> can be found on <a href="https://github.com/modelica/fmi-guides">github.com/modelica/fmi-guides</a>.</p>
</div>
<div class="paragraph">
<p><br>
</p>
</div>
<div class="paragraph">
<p>Copyright &#169; 2016-2020 prostep ivip project SmartSE and 2021-2023 The Modelica Association Project FMI.</p>
</div>
<div class="paragraph">
<p>This document is licensed under the Attribution-ShareAlike 4.0 International license.
The code is released under the 2-Clause BSD License.
The licenses text can be found in the <a href="https://raw.githubusercontent.com/modelica/fmi-guides/main/LICENSE.txt">LICENSE.txt</a> file that accompanies this distribution.</p>
</div>
<div class="paragraph">
<p>Attention is drawn to the possibility that some of the elements of this document may be the subject of patent rights.
Modelica Association and prostep ivip e.V. shall not be held responsible for identifying such patent rights.</p>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Functional Mock-up Interface (FMI) has gained widespread acceptance in industrial usage both at the level of users and simulation tool vendors as a mechanism for the interchange of models for integration into other environments.
During the initial adoption of FMI, several problems and omissions that have hindered the realization of the full potential of FMI adoption have been identified.
Many of these issues have resulted in clarifications and enhancements in the FMI 3.0 standard.
However, other considerations are less normative or require more deliberated guidance, so inclusion in the standard itself was deemed unwise.</p>
</div>
<div class="paragraph">
<p>This document provides best practice recommendations to implementers of FMI, focusing on FMI 3.0, derived from the industrial experience of the Smart SE project members and the MAP FMI community in employing FMI.
The overarching goal of the recommendations is to aid interoperability of FMI implementations and ensure good ease-of-use for the user in employing FMI.</p>
</div>
<div class="paragraph">
<p>This document is intended for simulation tool vendors planning to support FMI in their products, either for importing FMUs or for exporting FMUs, or both.
It assumes a technical audience familiar with the specification documents and tries to give further information and hints in areas where either the relevant specification documents have been found sometimes to be less clear than expected or where user expectations are relevant to implementation choices.
It also considers errors and bugs encountered in the practical use of existing FMI implementations and guides to avoid common pitfalls.</p>
</div>
<div class="paragraph">
<p>This document will be maintained and expanded over time as new issues or needs for clarification appear.</p>
</div>
<div class="paragraph">
<p>Since interoperability of implementations is of crucial concern for FMI users, guidance is, where applicable, based on the general robustness principle (also often termed Postelâ€™s law):</p>
</div>
<div class="quoteblock">
<blockquote>
Be conservative in what you do, be liberal in what you accept from others.
</blockquote>
</div>
<div class="paragraph">
<p>Note that the guidance in this document does in no way supplant the standards themselves:
What is standard-compliant or not is the sole domain of the official standard documents.</p>
</div>
<div class="paragraph">
<p>This guidance only expands on the content of the standards by giving advice on how to best deal with design decisions and the realities of diverging or not fully standard-compliant implementations:
Even if erroneous implementations are fixed at a later date, they will affect users in the meantime, and with generated FMUs, probably a long time after the exporters are fixed if the FMUs are not regenerated regularly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_general_considerations">2. General Considerations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_versions_of_fmi_to_support">2.1. Versions of FMI to support</h3>
<div class="paragraph">
<p>When planning on which versions of FMI to support in your implementation, support for the newest FMI version (currently FMI 3.0) is, of course, highly recommended.</p>
</div>
<div class="paragraph">
<p>It should be noted that there is no cross-version compatibility between major versions of FMI.</p>
</div>
<div class="paragraph">
<p>The life cycles of both simulation environments and generated FMUs can wildly differ and span many years in development projects.
Therefore support for both legacy FMU integration and generation of legacy FMUs is crucial for flexible interoperation in development projects.</p>
</div>
<div class="paragraph">
<p>Currently, this means that support for the very widely supported FMI version 2.0 should be strongly considered.
Similarly, support for the integration of FMUs using different FMI versions should also be strongly considered.</p>
</div>
<div class="paragraph">
<p>For FMI 1.0/2.0 and 3.0 interoperability the bridging between the different variable types of 1.0/2.0 and 3.0 and the handling of arrays needs to be taken into account.
In projects that employ the SSP standard, the variant handling facilities of SSP can be used to package multiple versions of an FMU into one package.</p>
</div>
<div class="paragraph">
<p>When bugfix releases of the FMI standard become available, implementations should take these into account in a timely fashion to react to detected clarifications in the standard.</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_interface_types">2.2. Support for Interface Types</h3>
<div class="paragraph">
<p>Generally, implementations should support all applicable FMI interface types:
For FMI 3.0, this includes the Model Exchange, Co-Simulation, and Scheduled Execution interface types.</p>
</div>
<div class="paragraph">
<p>There are inherent trade-offs in the properties of interface types in terms of complexity, numerical accuracy, performance, ease-of-use, and reproducibility of results.
For this reason, often not just one interface type is appropriate for the export of a given FMU.</p>
</div>
<div class="paragraph">
<p>FMI provides the ability to package multiple interface types in one FMU, allowing importers and users to select an appropriate interface type at the point of use.
This also enables importers to fall back to a different interface type if an interface type is not supported or is not beneficial for the current use case.</p>
</div>
<div class="paragraph">
<p>Especially for a more specialized or complex interface type, like Scheduled Execution, which is only relevant in some use cases, implementing other interface types as a fallback is recommended.</p>
</div>
<div class="paragraph">
<p>There are, of course, cases where the generation of only certain interface types makes sense:
For example, for FMUs generated from ECU software, the model exchange interface type is likely not sensible or possible to generate.</p>
</div>
<div class="paragraph">
<p>Importing implementations should usually support all interface types.
Mixing FMUs with different interface types in one model or project should also be supported unless technical considerations make this impossible or not useful.</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_optional_features">2.3. Support for Optional Features</h3>
<div class="paragraph">
<p>The FMI standard provides many optional features.
These features are optional since support is not uniformly required for all use cases.
However, for certain use cases, some optional features are often critically important.
Therefore broad support for optional features is required to achieve acceptable simulation performance for a broad range of use cases.</p>
</div>
<div class="paragraph">
<p>The Modelica Association Project FMI and the prostep ivip SmartSE project provide a joint publication on FMI Feature Profiles, which gives use-case-based guidance on required and recommended optional features.
The goal of this document is a more straightforward agreement between tool vendors and users on the required features for specific use cases.</p>
</div>
<div class="paragraph">
<p>This document can be found on the FMI standard homepage at <a href="https://fmi-standard.org/" class="bare">https://fmi-standard.org/</a> and should be taken into account, among other considerations, when defining feature support for implementations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing">2.4. Testing</h3>
<div class="paragraph">
<p>All implementers are advised to participate widely in the FMI Cross-Checking Initiative to test compatibility with current implementations of other tools.
Robust participation, including testing with a relevant selection of available releases, is recommended.</p>
</div>
<div class="paragraph">
<p>FMU exporting implementations should also use the FMU Compliance Checker <a href="#FMUCC">[FMUCC]</a> and VDMCheck <a href="#VDMCheck">[VDMCheck]</a> to do basic validation of generated FMUs.</p>
</div>
<div class="paragraph">
<p>FMU importing implementations should make use of the Reference FMUs <a href="#RefFMUs">[RefFMUs]</a> to do basic validation of FMU import.</p>
</div>
<div class="paragraph">
<p>Implementers should test FMU integration with complex test cases, including the behavior of multiple connected FMUs with actual and pseudo algebraic loops, iteration during initialization, handling of structured naming, handling of Unicode characters inside and outside the basic multilingual plane, license handling, etc.</p>
</div>
</div>
<div class="sect2">
<h3 id="_licensing_and_license_handling">2.5. Licensing and License Handling</h3>
<div class="paragraph">
<p>If generated FMUs require licenses to run (FMU runtime licenses), the mechanism needed to supply these licenses to the FMU needs to be documented, ideally included in the FMU documentation.</p>
</div>
<div class="paragraph">
<p>The license handling should be tested widely as part of cross-implementation checks to ensure that the license handling works correctly in varied circumstances.</p>
</div>
<div class="paragraph">
<p>If an error or problem occurs in the license handling, e.g., a missing license, an informative message should be provided to the user through the FMU logging callback mechanism.
This allows importing implementations to provide proper feedback to the user.</p>
</div>
<div class="paragraph">
<p>Exchange of FMUs can be eased tremendously if an option exists to generate FMUs that do not require license mechanisms at the receiving party.</p>
</div>
<div class="paragraph">
<p>If license mechanisms are used for IP protection, alternative approaches can be useful to consider (see, for example, Part D IP Protection of the prostep ivip SmartSE Recommendation 2022 PSI 11 V3.0 <a href="#SMARTSEV3">[SMARTSEV3]</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_packaging_and_code_generationloading">3. Packaging and Code Generation/Loading</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_zip_archive_structure">3.1. ZIP Archive Structure</h3>
<div class="sect3">
<h4 id="_pathnames_and_prefixes">3.1.1. Pathnames and Prefixes</h4>
<div class="paragraph">
<p>Exporting implementations should ensure that the generated FMU ZIP archives are compliant with the ZIP specification.
This implies that only the forward slash <code>/</code> shall be used as a path separator and that path specifications like <code>.</code> or <code>..</code> do not have specific interpretations, like the current directory, etc.</p>
</div>
<div class="paragraph">
<p>More specifically, the ZIP archive should only contain entries with no leading prefix:
For example, valid entries would be <code>modelDescription.xml</code> or <code>binaries/x86_64-windows/myfmu.dll</code>, not <code>./modelDescription.xml</code>, or <code>myfmu/binaries/x86_64-windows/myfmu.dll</code>.</p>
</div>
<div class="paragraph">
<p>To enable interoperation with not-quite conforming implementations, importing implementations should be prepared to support the extraction of FMU ZIP archives with leading <code>./</code> prefixes on entries in the archive.
Similarly, implementations should be prepared to support the extraction of FMU ZIP archives that use "\" as the path separator.</p>
</div>
</div>
<div class="sect3">
<h4 id="_access_to_fmu_package_content">3.1.2. Access to FMU package content</h4>
<div class="paragraph">
<p>The exporting implementation should not rely on the importing implementation completely unpacking the FMU in one location.
The standard only specifies access to the resources folder.</p>
</div>
<div class="paragraph">
<p>Some of the fallbacks (discussed in <a href="#_handling_of_code_dependencies">Section 3.7</a> and <a href="#_instantiation">Section 5.1</a>) for locating the resources folder relative to the executing DLL/shared object rely on the structure being completely recreated.
However, these fallbacks are, by their nature non-portable mechanisms, that only come into play when other, standard-conforming mechanisms are not available.</p>
</div>
<div class="paragraph">
<p>When possible, implementations should unpack the complete ZIP archive content in one location since some FMUs depend on this even if the standard only specifies access to the resources folder.</p>
</div>
<div class="paragraph">
<p>Note that FMI 3.0 provides access to the resource folder using a native path, whereas FMI 1.0 and FMI 2.0 specify a URI to the resource folder that still needs to be translated to a system path for access.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_documentation_and_additional_resources">3.2. Documentation and Additional Resources</h3>
<div class="sect3">
<h4 id="_icons">3.2.1. Icons</h4>
<div class="paragraph">
<p>Implementations should support using supplied icon information in the FMU when displaying the FMU in a graphical notation or user interface.</p>
</div>
<div class="paragraph">
<p>For FMI 3.0, icon information is available as part of the ports and icons information contained in the <code>icons/terminalsAndIcons.xml</code> file of the FMU.
This optionally includes detailed icon information for individual ports, as well as global icon information.</p>
</div>
<div class="paragraph">
<p>For prior versions of FMI, only a <code>model.png</code> file in PNG format in the root of the ZIP archive is available.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should, at a minimum, generate an informative icon for the FMU and package this in the ZIP archive in the way documented in the FMI standards.
Whenever possible, more detailed information should be provided using the ports and icons information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_meta_data">3.2.2. Meta Data</h4>
<div class="paragraph">
<p>Exporting implementations should make use of the standard meta data attributes FMI provides in the root element of the <code>modelDescription.xml</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>description</code><br>
A user-readable description of the FMU/model at a suitable level of detail for a short overview.
Note that additional information can be provided in the <a href="#_documentation">Section 3.2.3</a>.</p>
</li>
<li>
<p><code>author</code><br>
Author information should ideally include organization and contact information, e.g. in the <a href="#RFC5322">[RFC5322]</a> <code>name-addr</code> format:<br>
<code>Example User &lt;<a href="mailto:user@example.com">user@example.com</a>&gt;</code><br>
Note that privacy regulations might necessitate the use of author information that is not personally identifiable, e.g. company or department names and addresses instead of individual users.</p>
</li>
<li>
<p><code>version</code><br>
This field provides a version for the FMU/model, which is not to be confused with the FMI version field <code>fmiVersion</code>.</p>
</li>
<li>
<p><code>copyright</code><br>
Copyright information in a suitably short form.
Note that additional information can be provided in the <a href="#_documentation">Section 3.2.3</a>.</p>
</li>
<li>
<p><code>license</code><br>
License information in a suitably short form.
Note that additional information can be provided in the <a href="#_documentation">Section 3.2.3</a>.</p>
</li>
<li>
<p><code>generationTool</code><br>
Description, including version number, on the tool generating the FMU.</p>
</li>
<li>
<p><code>generationDateAndTime</code><br>
Date and time when the FMU was generated.
Note the specific <a href="#ISO8601-1">[ISO8601-1]</a>-derived format required here, and the prescribed use of UTC (Zulu time zone):<br>
<code>2009-12-08T14:33:22Z</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While some of the fields can be filled in a fully automated fashion, for most user input is needed.
Generally the information to be included in generated FMUs should be fully under user control.</p>
</div>
<div class="paragraph">
<p>Importing implementations should make the meta data found in imported FMUs available to the user for inspection.</p>
</div>
<div class="paragraph">
<p>Note that not all of the meta data fields are available in FMI 1.0.</p>
</div>
</div>
<div class="sect3">
<h4 id="_documentation">3.2.3. Documentation</h4>
<div class="paragraph">
<p>The documentation folder of FMUs provides a specific way to ensure that important documentation needed to use FMUs effectively always travel with the FMU.
Implementations should therefore allow easy access to any documentation supplied in the FMU.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should allow the user to easily author/add documentation for the FMU.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should also include any additional documentation needed to effectively run the FMU in the documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implementations which export FMUs that are not considered stand-alone, i.e., specifying <code>needsExecutionTool=true</code> in their model description, should provide sufficient information inside the documentation so that the recipient of the FMU will know what tools, licenses, and other dependencies are needed to run the FMU.</p>
</li>
<li>
<p>Implementations which export FMUs that require runtime licenses should provide information on what kind of license is needed and how to provide this license so the FMU can use it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In many instances, for example, when open-source licenses are employed, license information and other additional information is needed to be shipped with an FMU for distribution.
In these cases, exporting implementations should allow the user to easily add information items, like licenses, to the documentation shipped with an FMU.</p>
</div>
<div class="paragraph">
<p>Where the license information is required by the exporting implementation itself, it can directly add this information to the FMU itself.</p>
</div>
<div class="paragraph">
<p>This support by an implementation should not be understood to remove the need for the user to ensure that they are in compliance with relevant licenses and their legal obligations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_3264bit_variants_of_platforms">3.3. Support for 32&amp;64bit Variants of Platforms</h3>
<div class="paragraph">
<p>Common platforms in use today are available in 32bit and 64bit variants, for example Windows or Linux on Intel processors, or Linux ARM processors.</p>
</div>
<div class="paragraph">
<p>While these variants are usually closely related, and 64bit variants commonly support running 32bit and 64bit binaries side-by-side, this support is limited:
Most platforms do not support running 32bit and 64bit inside one process image, but only in separate processes.</p>
</div>
<div class="paragraph">
<p>Since FMI is designed around the ability to run FMUs inside the host implementation process image for efficiency, this means that 32bit and 64bit variants of the same platform are usually not directly compatible.</p>
</div>
<div class="paragraph">
<p>For this reason exporting implementations should ideally generate FMUs that contain both 32bit and 64bit variants of the binaries, allowing importers to select an appropriate binary.</p>
</div>
<div class="paragraph">
<p>Since not all exporting implementations can generate both variants easily, importing implementations should consider providing the ability to bridge between 32bit and 64bit implementations, using either inter-process communication or system provided facilities where possible.</p>
</div>
<div class="paragraph">
<p>Going forward, this is likely to be less of a problem on desktop systems, which are migrating to 64bit only implementation spaces.
For mobile or embedded platforms, this issue is likely to be still pertinent for some time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_multiple_platforms">3.4. Support for Multiple Platforms</h3>
<div class="paragraph">
<p>FMU exporting implementations should strive to support common platforms out of the box.
They should provide support for generating FMUs that contain multiple binary implementations, and where feasible, a source code implementation in one go.</p>
</div>
</div>
<div class="sect2">
<h3 id="_compiler_dependencies">3.5. Compiler Dependencies</h3>
<div class="paragraph">
<p>Exporting implementations should document supported compilers, their versions, and required compiler flags and settings to compile generated source FMUs for common platforms.</p>
</div>
<div class="paragraph">
<p>For FMI 3.0, the compilers and required compiler flags and settings should be placed in the <code>buildDescription.xml</code> file of the FMU to allow automated building from source as far as possible.</p>
</div>
<div class="paragraph">
<p>When generating binary FMUs directly, the supported and used compilers, compiler flags, and settings should also be documented.
This allows users to troubleshoot integration issues when integrating binary FMUs into other environments.</p>
</div>
<div class="paragraph">
<p>Where possible, user-supplied compilers, compiler flags, and settings should be supported to automate the generation of binary FMUs for non-common targets or to support user-specific requirements in the binary FMU compilation/linking stage.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_of_fmu_namespaces">3.6. Handling of FMU namespaces</h3>
<div class="paragraph">
<p>Importing implementations should correctly handle the import of multiple FMI 1.0 FMUs with identical model identifiers.
In the case of FMUs with dynamic library implementations, this is supported by most platforms since symbol lookup can be performed scoped to one dynamic library namespace (see, for example, the <code>dlsym</code> and <code>GetProcAddr</code> functions for Linux and Windows, respectively).</p>
</div>
<div class="paragraph">
<p>Starting with FMI 2.0, FMUs with dynamic library implementations will always use identical symbols for the entry points in any case, so that this has to be supported correctly.</p>
</div>
<div class="paragraph">
<p>For source code or static library implementations, the problem of conflicting model identifiers can usually only be solved through compilation/linking to corresponding separate dynamic libraries or other similar mechanisms to deal with the relevant scoping issues.</p>
</div>
<div class="paragraph">
<p>For source code FMUs in FMI 3.0, the actual prefix that is used for the entry points is controlled through the mechanisms of the <code>fmi3Functions.h</code> header in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The source code of the FMU predefines the <code>FMI3_FUNCTION_PREFIX</code> preprocessor macro with the function prefix that matches the <code>modelIdentifier</code> attribute given in the <code>modelDescription.xml</code>.
This is done before including the <code>fmi3Functions.h</code> header.</p>
</li>
<li>
<p>If the <code>fmi3Functions.h</code> header supplied with the standard is used for compilation, then this predefined prefix will be used as the function prefix, unless the <code>FMI3_OVERRIDE_FUNCTION_PREFIX</code> preprocessor macro is defined.
If this macro is defined, then the actual function prefix will be taken from the preprocessor macro <code>FMI3_ACTUAL_FUNCTION_PREFIX</code>, if it is defined, or no prefix will be used, if it is undefined.</p>
</li>
<li>
<p>If an importing implementation requires something different, it can provide a <code>fmi3Functions.h</code> header file that does whatever the implementation requires, ignoring or using the predefined <code>FMI3_FUNCTION_PREFIX</code> macro as it sees fit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As the actual function symbols generated for an FMU are dependent on the implementation and its supplied <code>fmi3Functions.h</code> header any any other predefined preprocessor macros, FMU exporters must ensure that they only refer to the FMI API entry-points via the names generated from the <code>fmi3Functions.h</code> mechanisms.
In other words, any references in the exported source code should be amenable to preprocessor expansion.</p>
</div>
<div class="paragraph">
<p>For FMI 2.0 source code FMUs a similar approach can be used, however there are fewer guarantees on pre-defined preprocessor macros, since this area was only clarified in later patch releases of 2.0.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_of_code_dependencies">3.7. Handling of Code Dependencies</h3>
<div class="paragraph">
<p>Importing implementations should consider changing the working directory of the process to the relevant binary subdirectory of the unpacked FMU when loading the FMU dynamic library.
This is to allow unsophisticated exporting implementations to load dependent dynamic libraries relative to this directory.
It is, of course, the responsibility of the FMU to implement proper dependent dynamic library loading regardless of the current working directory of the process.
However, in practice, a number of current or former implementations did not correctly implement this.
They can thus fail to load when the current directory is not the directory that contains the FMU dynamic library.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should ideally avoid reliance on additional dynamic libraries:
Generated dynamic libraries should ideally be stand-alone.</p>
</div>
<div class="paragraph">
<p>Where this is not feasible, implementations should prefer to use manual dynamic loading of dependent libraries at runtime (for example, using <code>dlopen</code> or <code>LoadLibrary</code>).
The load path of the libraries should be based on the path to the resources folder provided.
When the resources path is not available (for example, in FMI 1.0 ME) or not valid, an implementation can use dynamic library-relative path derivation, either against the binary folder or the resources folder.</p>
</div>
<div class="paragraph">
<p>Relying on pre-linking, where the dynamic loading of the dependent libraries is automatically handled by the platform dynamic linker/loader, is not likely to work in all cases:
For example, on Windows, the searched paths will be based on the location of the importer executable, not the location of the FMU DLL.
Furthermore, in case of failure, automatic linking is unlikely to provide user-understandable error messages.</p>
</div>
<div class="paragraph">
<p>Note that simple calls to <code>LoadLibrary</code> or <code>LoadLibraryEx</code> on Windows, without specifying the full path to the library are also not going to work in general, for the same reasons:
The search path will be based on the location of the importer executable and not the FMU DLL.</p>
</div>
<div class="paragraph">
<p>Importers should consider using flags like <code>RTLD_LOCAL</code> on POSIX platforms with <code>dlopen</code>, to avoid symbols from loaded shared objects being resolved against other loaded shared objects (i.e. other FMUs) by accident.</p>
</div>
<div class="paragraph">
<p>Note that for POSIX platforms, like Linux, <code>dlclose</code> is not required to unload a shared object, but it can, as specified in IEEE Std 1003.1-2017 (and earlier).
In particular, shared objects compiled with GCC without the flag <code>-fno-gnu-unique</code>, can be marked as unloadable, and thus will not generally be unloaded upon <code>dlclose</code>.
In many instances shared objects loaded with <code>RTLD_GLOBAL</code> cannot unload until all relocations of other objects to symbols in the shared object have been unloaded.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interaction_between_fmu_and_importer">3.8. Interaction between FMU and Importer</h3>
<div class="paragraph">
<p>The FMU code will run in the process environment that the importer provides.
This might be the same process as the importer, or it might be a separate process or processes.
The FMU code cannot make any assumptions on this, but must rather be conservative in its behavior in the face of this.</p>
</div>
<div class="sect3">
<h4 id="_global_state">3.8.1. Global State</h4>
<div class="paragraph">
<p>The functions the FMU provides must not change global settings which affect the overall process and/or thread environment:</p>
</div>
<div class="paragraph">
<p>For example, an FMU function must not change the current working directory of the process, since this is by definition visible outside of the current execution thread.</p>
</div>
<div class="paragraph">
<p>FMU funtions can, on the other hand, change the floating point control word of the CPU during their execution, since this is directly tied to the thread of execution.
However they must restore the floating point control word before returning, so as to not affect state outside of the current thread of execution.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parameter_and_variable_handling">4. Parameter and Variable Handling</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_support_for_physical_units">4.1. Support for Physical Units</h3>
<div class="paragraph">
<p>Importing implementations should support the processing of physical unit information when present on the variables of an imported FMU, including support for unit consistency checks and optional automatic unit conversions, especially when FMI 2.0/3.0 SI-based unit information is available.</p>
</div>
<div class="paragraph">
<p>The unit information should be overridable by the user to account for exceptional circumstances:
For example, when erroneous unit information on a variable has to be manually adjusted since changes to the FMU are not otherwise practicable.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should generate physical unit information on all exported variables when such information is available in the model (or can be automatically derived).</p>
</div>
<div class="paragraph">
<p>On FMI 2.0 and later versions, the support for SI-based units, using the <code>BaseUnit</code> element should be used.
This enables a number of important use cases:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Unit check when connecting variables of different FMUs</dt>
<dd>
<div class="paragraph">
<p>When only one of an input variable <code>v2</code> and an output variable <code>v1</code>, connected with equation <code>v2 = v1</code>, defines a <code>BaseUnit</code> element, or neither does, the connection equation <code>v2 = v1</code> holds.</p>
</div>
<div class="paragraph">
<p>When two variables <code>v1</code> and <code>v2</code> (of the same or different FMUs) are connected and for both of them <code>BaseUnit</code> elements are defined, then they must have identical exponents of their <code>BaseUnit</code>.
If both <code>factor</code> and <code>offset</code> attributes are also identical, the connection equation <code>v2 = v1</code> again holds.
If <code>factor</code> and <code>offset</code> are not identical, the tool may either trigger an error or, if supported, perform a conversion; in other words, use the connection equation (in this case the <code>relativeQuantity</code> of the <code>TypeDefinition</code>, see below, has to be taken into account in order to determine whether <code>offset</code> shall or shall not be utilized):</p>
</div>
<div class="paragraph">
<p><code>factor(v1) * v1 + (if relativeQuantity(v1) then 0 else offset(v1)) = factor(v2) * v2 + (if relativeQuantity(v2) then 0 else offset(v2))</code><br>
where <code>relativeQuantity(v1) = relativeQuantity(v2)</code> is required.</p>
</div>
<div class="paragraph">
<p>As a result, wrong connections can be detected (for example, connecting a force with an angle-based variable would trigger an error) and conversions between, say, US and SI units can be either automatically performed or, if not supported, an error is triggered as well.</p>
</div>
<div class="paragraph">
<p>This approach is not satisfactory for variables belonging to different quantities that have, however, the same <code>BaseUnit</code>, such as quantities <code>Energy</code> and <code>Torque</code>, or <code>AngularVelocity</code> and <code>Frequency</code>.
To handle such cases, quantity definitions have to be taken into account (see <code>TypeDefinitions</code>) and quantity names need to be standardized.</p>
</div>
<div class="paragraph">
<p>This approach allows a general treatment of units, without being forced to standardize the grammar and allowed values for units (for example, in FMI 1.0, a unit could be defined as <code>N.m</code> in one FMU and as <code>N*m</code> in another FMU, and a tool would have to reject a connection, since the units are not identical.
In FMI 2.0 and later, the connection would be accepted, provided both elements have the same <code>BaseUnit</code> definition).</p>
</div>
</dd>
<dt class="hdlist1">Dimensional analysis of equations</dt>
<dd>
<div class="paragraph">
<p>In order to check the validity of equations in a modeling language, the defined units can be used for dimensional analysis, by using the <code>BaseUnit</code> definition of the respective unit.
For this purpose, the <code>BaseUnit</code> <code>rad</code> has to be treated as <code>1</code>.
Example:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
J \cdot \alpha = \tau \rightarrow [kg.m^2]*[rad/s^2] = [kg.m^2/s^2] &amp; \quad \text{// o.k. ("rad" is treated as "1")} \\
J \cdot \alpha = f \rightarrow [kg.m^2]*[rad/s^2] = [kg.m/s^2] &amp; \quad \text{// error, since dimensions do not agree}
\end{align*}\]
</div>
</div>
</dd>
<dt class="hdlist1">Unit propagation</dt>
<dd>
<div class="paragraph">
<p>If unit definitions are missing for variables, they might be deduced from the equations where the variables are used.
If no unit computation is needed, <code>rad</code> is propagated.
If a unit computation is needed and one of the involved units has <code>rad</code> as a <code>BaseUnit</code>, then unit propagation is not possible.
Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a = b + c, and <code>Unit</code> of c is provided, but not <code>Unit</code> of a and b:<br>
The Unit definition of <code>c</code> (in other words, <code>Unit.name</code>, <code>BaseUnit</code>, <code>DisplayUnit</code>) is also used for <code>a</code> and <code>b</code>.
For example, if BaseUnit(c) = <code>rad/s</code>, then BaseUnit(a) = BaseUnit(b) = <code>rad/s</code>.</p>
</li>
<li>
<p>a = b*c, and <code>Unit</code> of a and of c is provided, but not <code>Unit</code> of b:<br>
If <code>rad</code> is either part of the <code>BaseUnit</code> of <code>a</code> and/or of <code>c</code>, then the <code>BaseUnit</code> of <code>b</code> cannot be deduced (otherwise it can be deduced).
Example: If <code>BaseUnit(a) = kg.m/s2</code> and <code>BaseUnit(c) = m/s2</code>, then the <code>BaseUnit(b) can be deduced to be `kg</code>.
In such a case <code>Unit.name</code> of b cannot be deduced from the <code>Unit.name</code> of <code>a</code> and <code>c</code>, and a tool would typically construct the <code>Unit.name</code> of <code>b</code> from the deduced <code>BaseUnit</code>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_minmax_range_information">4.2. Support for Min/Max Range Information</h3>
<div class="paragraph">
<p>Importing implementations should support the processing of min/max limit information when present on the variables of an imported FMU.
This support should include support for limit consistency checks and optional runtime checking.</p>
</div>
<div class="paragraph">
<p>The limit information should be overridable by the user to account for exceptional circumstances:
For example, when erroneous limits on a variable have to be manually adjusted since changes to the FMU are not otherwise practicable.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should generate min/max limit information on all exported variables that support this information in FMI when such limit information is available in the model (or can be automatically derived).
Ideally, it should be possible to generate FMUs that optionally check the limits (especially user-supplied limits) at runtime and produce suitable errors and diagnostic logging information when limits are breached.</p>
</div>
<div class="paragraph">
<p>Implementations are well-advised to heed the explanations in section 2.2.6.3 of the FMI 3.0 standard when implementing min/max checking and handling routines.</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_structured_naming_convention">4.3. Support for Structured Naming Convention</h3>
<div class="paragraph">
<p>Importing and exporting implementations should support the structured naming convention for variables specified in the FMI standards to support the interchange of array/matrix and record/struct information.</p>
</div>
<div class="paragraph">
<p>Starting with FMI 3.0, FMI also supports array variables directly (called native arrays in the following discussion), i.e. without needing to use scalar variables and the structured naming convention.
Hence, for FMI 3.0, implementations should support both native arrays and the structured naming convention.
This support should include support for bridging between these two ways of expressing arrays, especially when supporting older versions of FMI as well as FMI 3.0.
When exporting arrays, preference should be given to native arrays over structured naming convention mappings.</p>
</div>
<div class="paragraph">
<p>Importing implementations should map complex interfaces expressed via the structured naming convention to suitable internal data structures and formats, like vectors/arrays, records/structs, or busses.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should map their internal data structures to suitable FMI structured names, mapping vectors to arrays, and records/structs or busses to hierarchical names.</p>
</div>
<div class="paragraph">
<p>If an implementation supports importing as well as exporting FMUs, the mapping of data structures should allow for efficient round-tripping:
It should be possible to export (part of) a model as an FMU with complex data structures at its interface and have that FMU use structured naming in such a way that the resulting FMU can be imported into the same tool and support the same native interface.</p>
</div>
<div class="paragraph">
<p>Parameter editors and similar editing UIs and APIs should efficiently support complex data types so that a multi-dimensional array can be efficiently edited, both in terms of speed and user interface.</p>
</div>
<div class="paragraph">
<p>Exporting complex data structures through the structured naming convention can easily lead to 10,000 or more scalar variables.
Implementations should therefore be prepared to deal with FMUs containing very many scalar variables efficiently.</p>
</div>
</div>
<div class="sect2">
<h3 id="_selection_of_exported_parametersvariables">4.4. Selection of Exported Parameters/Variables</h3>
<div class="paragraph">
<p>In order to generate FMUs that are easily handled and also to guard against exposing too many internal details (for both IP protection reasons and reasons of clarity of interfaces), exporting implementations should allow the user to efficiently select which parameters or variables are to be exposed in the FMU as parameters and variables, and which should be kept hidden.</p>
</div>
<div class="paragraph">
<p>In the case of state variables, this must be done in accordance with the requirements of the standards:
Certain state variables always have to be exposed in Model Exchange FMUs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_simulation">5. Simulation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_instantiation">5.1. Instantiation</h3>
<div class="paragraph">
<p>Importing implementations must pass valid values into the following instantiation calls for all of their arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FMI 3.0: <code>fmi3InstantiateModelExchange</code>, <code>fmi3InstantiateCoSimulation</code>, and <code>fmi3InstantiateScheduledExecution</code></p>
</li>
<li>
<p>FMI 2.0: <code>fmi2Instantiate</code></p>
</li>
<li>
<p>FMI 1.0: <code>fmiInstantiate</code>, <code>fmiInstantiateSlave</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note especially that null pointers are not valid for any of the string arguments to these functions, unless explicitly allowed in the respective standard.
Implementations must pass proper values especially for the following fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>instanceName</code> must not be the null pointer, the empty string or a string only containing whitespace.</p>
</li>
<li>
<p><code>instantiationToken</code> (3.0), <code>fmuGUID</code> (2.0), and <code>GUID</code> (1.0)  must match the value of the <code>instantiationToken</code> (3.0) and <code>guid</code> (2.0/1.0) attribute from the modelDescription.xml file, respectively.</p>
</li>
<li>
<p>For FMI 3.0, <code>resourcePath</code> must be a valid native path to the FMU&#8217;s <code>resources</code> directory.
If an FMU has no <code>resources</code> directory or if no such path can be provided due to implementation restrictions the <code>resourcePath</code> argument must be a null pointer.</p>
</li>
<li>
<p>For FMI 2.0/1.0 <code>fmuResourceLocation</code>/<code>fmuLocation/</code> must be a valid URI (per RFC 3986), and should be a URI with the <code>file</code> scheme, since that is currently the only scheme that is required to be supported by the FMU.
Note that the description of this in the FMI 1.0 standards is very unclear and confusing, so that in practice, until a proper cleanup version of the 1.0 standard is released, as far as valid URIs are concerned the implementation should follow the spirit of the rules as laid out in the FMI 2.0 standard for the fmuResourceLocation argument, but pointing to the root of the unpacked FMU archive rather than the resources directory.
Note also that <code><a href="file://C:/" class="bare">file://C:/</a></code> and similar are not valid file URIs, but should rather be supplied as either <code><a href="file:///C:/" class="bare">file:///C:/</a></code> (empty authority) or as <code>file:/C:/</code> (missing authority) to be valid URIs.
Furthermore the validity of a URI is not influenced by the existence or non-existence of the file/directory pointed to, so that in the case of FMI 2.0, a URI pointing to the resources directory would still be a valid URI, even if the unpacked FMU archive did not contain a resources directory.</p>
</li>
<li>
<p><code>mimeType</code> (FMI 1.0 only) must not be null and must be a valid MIME type; unless specific requirements indicate otherwise, <code>application/x-fmu-sharedlibrary</code> is the proper string to pass here.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If an importer tries to create a second instance of an FMU where the capability flag <code>canBeInstantiatedOnlyOncePerProcess</code> is true, the FMU should provide an error message and return <code>NULL</code>.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should guard (by safely handling these cases without crashing) against common errors in calls to the instantiation functions, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>instanceName</code>, <code>GUID</code>/<code>fmuGUID</code>/<code>instantiationToken</code>, <code>fmuLocation</code>/<code>fmuResourceLocation</code> and <code>mimeType</code> might all be null pointers or empty strings, or otherwise invalid,</p>
</li>
<li>
<p><code>GUID</code>/<code>fmuGUID</code>/<code>instantationToken</code> is possibly not the <code>guid</code>/<code>instantiationToken</code> attribute from the model description, but something else entirely (i.e. neither the guid attribute from this version of the FMU nor from a former version),</p>
</li>
<li>
<p>Especially under FMI 1.0 <code>fmuLocation</code> is very likely not pointing to the right location (either pointing to the resources directory, or the root directory of the unzipped FMU, to the zipped FMU, or to a different directory entirely), or is an invalid URI (e.g. <code><a href="file://C:/something" class="bare">file://C:/something</a></code> or the empty string) or of an unknown scheme.
This of course makes resource-loading difficult.
For Model Exchange FMUs (which are not passed an <code>fmuLocation</code> argument in any case) and for Co-Simulation FMUs (which often get these kinds of illegal/unclear URIs) as a fallback mechanism, it is recommended to load resources from paths derived from the location of the SharedObject/DLL for platforms that support this:
On Win32 for example this can be achieved through the use of <code>GetModuleFileName</code> with the <code>module_handle</code> of the DLL (as provided in a <code>DllMain</code> argument), or via <code>dladdr</code> on a known symbol in the FMU on OS X or Linux and similar ELF-based systems.
Note that this kind of mechanism should only be used as a fallback, if <code>fmuLocation</code> is not provided (ME FMUs) or is invalid in some way.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_initialization">5.2. Initialization</h3>
<div class="paragraph">
<p>When performing initialization of variable values, including parameters and initial values for other variables, importers should not rely on default values being already set in the FMU (i.e. burned into the binary so to speak):
While the FMI standards specify that default values shall both be specified in the <code>modelDescription.xml</code> file and are already set in the FMU upon instantiation, some implementations generate FMUs where this is not true, i.e. the default values of variables when not set do not match the values as specified in the <code>modelDescription.xml</code> file.
Since there is little effort in actually setting default values through the FMI API at initialization time, the more conservative approach is to always set default values through the API based on the <code>modelDescription.xml</code> file, or on the actual parameter/initial values as specified by the user, not relying on any burned-in default values.</p>
</div>
<div class="paragraph">
<p>Exporting implementations must ensure that any default values specified for variables in the <code>modelDescription.xml</code> file are actually â€œburned-inâ€:
The values shall be set automatically as default values upon FMU instantiation, so that importing implementations can rely on the standard-mandated behavior that unset variables have their default values as specified in the <code>modelDescription.xml</code>.</p>
</div>
<div class="paragraph">
<p>Note that for all start values, especially the mandatory start values for input and parameter variables, it is the responsibility of the FMU&#8201;&#8212;&#8201;and hence the exporter or the user of the exporter&#8201;&#8212;&#8201;to provide suitable start values:
An importer should be able to rely on these start values, i.e. it is always at liberty to use them unchanged, if no better start values are available to the importer.</p>
</div>
<div class="paragraph">
<p>If an FMU provides start values that e.g. result in a division-by-zero or some other error inside the FMU if unchanged, these are obviously not suitable start values, and should not have been selected.</p>
</div>
<div class="paragraph">
<p>Importers should however be aware of the existence of such FMUs, which can easily result from negligence during creation of an FMU:
Importers should, if more suitable start values are available, set them at the earliest permissible point in time, to avoid uneccesarily triggering such errors in the FMU.
For FMI 2.0/3.0, for example, different start values for inputs and parameters can and should already be set after instantiation, prior to entering initialization mode.</p>
</div>
<div class="paragraph">
<p>Importers should respect the different order of necessary function calls between FMI 1.0 and FMI 2.0/3.0 when performing initialization (this phase has seen larger changes between FMI 1.0 and 2.0/3.0 due to the introduction of explicit phases/modes in the FMI API, whereas these phases where only implicit in FMI 1.0).</p>
</div>
</div>
<div class="sect2">
<h3 id="_startup">5.3. Startup</h3>
<div class="paragraph">
<p>For FMI 1.0 Co-Simulation FMUs importing implementations should honor the <code>canHandleEvents</code> capability of the FMU: If this capability flag is false, then the implementation cannot call the <code>doStep</code> function with zero <code>communicationStepSize</code>, even at time 0 (used e.g. for generating valid initial values).
In these cases the integration environment must start simulation with the first simulation step, without any event iteration.
With FMI 2.0 Co-Simulation FMUs do not support 0-size time steps in any case.
With FMI 3.0, Co-Simulation FMUs can support event handling explicitly via the <code>hasEventMode</code> capability flag.
Importers can make use of this feature by passing <code>fmi3True</code> for the <code>eventModeUsed</code> argument of the <code>fmi3InstantiateCoSimulation</code> call.</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_solvers">5.4. Support for Solvers</h3>
<div class="paragraph">
<p>Importing implementations should support a wide variety of solver algorithms, in order to support Model-Exchange FMUs as fully as possible.
Ideally this should include support for attaching external solvers through specified APIs, so that experienced users can extend the supported solver base for specific new domains where appropriate.
Supporting the use of several different solvers in one model that integrates a number of FMUs, so that e.g. different Model Exchange FMUs can be solved through different solvers than other parts of the model â€“ without resorting to Co-Simulation FMUs â€“ can be beneficial in terms of performance and usability.</p>
</div>
<div class="paragraph">
<p>In any case the proper documentation of the employed solver algorithms and their configurable settings is very beneficial in understanding and handling differences between implementations.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should offer all of their built-in solver algorithms (including solver settings like step-size, tolerance, etc.) for export when generating Co-Simulation FMUs, so that the same solvers can be used inside the environment as in exported FMUs.
This should ideally also include the ability to export Co-Simulation FMUs using user-supplied solvers, where appropriate (e.g. where the environment supports the integration of external solvers for model evaluation).</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_for_mixing_fmus_types">5.5. Support for Mixing FMUs Types</h3>
<div class="paragraph">
<p>Importing implementations should support mixing FMUs of different types (and different FMI versions) in one simulation model, ensuring proper semantics for connections between those FMUs and each other as well as the rest of the simulation model.
This should also be checked in cross-checking with other implementations.</p>
</div>
<div class="paragraph">
<p>As a side issue, importing implementations should try to use as much of the fine-grained direct dependency information potentially present in FMI 1.0 (and even more so in FMI 2.0/3.0) as possible, in order to avoid algorithmic loops being detected where they are not really present.</p>
</div>
</div>
<div class="sect2">
<h3 id="_logging_support">5.6. Logging Support</h3>
<div class="paragraph">
<p>Importing implementations should allow fine-grained selection of FMU logging output recording/display, either based on the new FMU-defined logging categories for FMI 2.0/3.0 or on the raw string category argument of the logging callback in FMI 1.0.</p>
</div>
<div class="paragraph">
<p>Note that since the logging callback type signature in FMI 1.0 and 2.0 uses a variable argument list, this can have implications for the calling convention of that function on platforms that have different calling conventions for C functions with variable argument lists than for functions with fixed argument lists.</p>
</div>
<div class="paragraph">
<p>Starting with FMI 3.0, the logging callback uses a fixed argument list.</p>
</div>
<div class="paragraph">
<p>Exporting implementations should support the fine-grained selection of logging categories in FMI 2.0/3.0 and should use fine-grained category names in the category argument for FMI 1.0 logging callback calls.</p>
</div>
<div class="paragraph">
<p>In FMI 1.0 they should try to not produce verbose logging output when the debug logging flag is <code>fmiFalse</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_of_dependency_information">5.7. Handling of Dependency Information</h3>
<div class="paragraph">
<p>FMI 2.0/3.0 provide comprehensive information about the structure of a model encapsulated as an FMU, as defined in the element <code>ModelStructure</code> of the <code>modelDescription.xml</code>.</p>
</div>
<div class="paragraph">
<p>This element defines the dependencies between variables, both during initialization as well as at runtime, which may differ.</p>
</div>
<div class="paragraph">
<p>The following examples demonstrate in more detail how this information can be understood and used.</p>
</div>
<div class="sect3">
<h4 id="_example_1">5.7.1. Example 1</h4>
<div class="paragraph">
<p>An FMU is defined by the following equations:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}

\frac{d}{\text{dt}}\begin{bmatrix}
x_{1} \\
x_{2} \\
x_{3} \\
\end{bmatrix}

&amp;=

\begin{bmatrix}
f_{1}\left( x_{2} \right) \\
f_{2}\left( x_{1} \right) + 3 \cdot p^{2} \cdot x_{2} + 2 \cdot u_{1} + 3 \cdot u_{3} \\
f_{3}\left( x_{1},x_{3},u_{1},u_{2},u_{3} \right) \\
\end{bmatrix}

\\

y &amp;= g_1(x_2, x_3)

\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>where \({u_{1}}\) is a continuous-time input (<code>variability</code> = <code>continuous</code>), \({u_{2}}\) is any type of input, \({u_{3}}\) is a floating-point discrete-time input (<code>variability</code> = <code>discrete</code>), and \({p}\) is a fixed parameter (<code>variability</code> = <code>fixed</code>).</p>
</div>
<div class="paragraph">
<p>The initialization is defined by:</p>
</div>
<div class="stemblock">
<div class="content">
\[x_1 = 1.1, \frac{dx_2}{dt} = 0, y = 3.3,\]
</div>
</div>
<div class="paragraph">
<p>and therefore, the initialization equations are:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
x_{2} &amp;= \frac{1}{3 \cdot p^{2}} \cdot ( f_{2}\left( x_{1} \right) + 2 \cdot u_{1} + 3 \cdot u_{3} )
\\
x_{3} &amp;= g_{1}^{- 1}( x_{2}, y)
\end{align*}\]
</div>
</div>
<div class="paragraph">
<p>The model structure for this equation system can be defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ModelVariables&gt;
   &lt;Float64 name="p"       valueReference= "1" causality="parameter" variability="fixed" start="0"/&gt;
   &lt;Float64 name="u1"      valueReference= "2" causality="input" start="0"/&gt;
   &lt;Float64 name="u2"      valueReference= "3" causality="input" start="0"/&gt;
   &lt;Float64 name="u3"      valueReference= "4" causality="input" variability="discrete" start="0"/&gt;
   &lt;Float64 name="x1"      valueReference= "5"/&gt;
   &lt;Float64 name="x2"      valueReference= "6"/&gt;
   &lt;Float64 name="x3"      valueReference= "7"/&gt;
   &lt;Float64 name="der(x1)" valueReference= "8" derivative="5"/&gt;
   &lt;Float64 name="der(x2)" valueReference= "9" derivative="6"/&gt;
   &lt;Float64 name="der(x3)" valueReference="10" derivative="7"/&gt;
   &lt;Float64 name="y"       valueReference="11" causality="output"/&gt;
&lt;/ModelVariables&gt;
&lt;ModelStructure&gt;
   &lt;Output valueReference="11" dependencies="6 7"/&gt;
   &lt;ContinuousStateDerivative valueReference="8"  dependencies="6"/&gt;
   &lt;ContinuousStateDerivative valueReference="9"  dependencies="2 4 5 6" dependenciesKind="constant constant dependent fixed"/&gt;
   &lt;ContinuousStateDerivative valueReference="10" dependencies="2 3 4 5 6" /&gt;
   &lt;InitialUnknown valueReference="6" dependencies="2 4 5"/&gt;
   &lt;InitialUnknown valueReference="7" dependencies="2 4 5 11"/&gt;
   &lt;InitialUnknown valueReference="8"/&gt;
   &lt;InitialUnknown valueReference="10"/&gt;
   &lt;InitialUnknown valueReference="11"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_2">5.7.2. Example 2</h4>
<div class="paragraph">
<p>An FMU is defined by the following equation:</p>
</div>
<div class="stemblock">
<div class="content">
\[y = \left\{ \begin{matrix}
2 \cdot u \ \mathrm{if} \ u &gt; 0 \\
3 \cdot u \ \mathrm{else} \\
\end{matrix}\right.\]
</div>
</div>
<div class="paragraph">
<p>where \({u}\) is a continuous-time input with <code>valueReference</code> = <code>1</code> and \({y}\) is a continuous-time output with <code>valueReference</code> = <code>2</code>.</p>
</div>
<div class="paragraph">
<p>The definition of the model structure is then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ModelVariables&gt;
   &lt;Float64 name="u" valueReference= "1" causality="input" start="1"/&gt;
   &lt;Float64 name="y" valueReference= "2" causality="output"/&gt;
&lt;/ModelVariables&gt;
&lt;ModelStructure&gt;
  &lt;Output valueReference="2" dependencies="1" dependenciesKind="discrete"/&gt;
  &lt;InitialUnknown valueReference="2"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that \({y = d \cdot u}\) where \({d}\) changes only during event mode (\({d = 2 \cdot u}\) or \({3 \cdot u\ }\) depending on relation \({u &gt; 0}\) that changes only at event mode).
Therefore <code>dependenciesKind</code> = <code>discrete</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_3">5.7.3. Example 3</h4>
<div class="paragraph">
<p>An FMU is defined by the following equation:</p>
</div>
<div class="stemblock">
<div class="content">
\[y = \left\{ \begin{matrix}
2\ \ \mathrm{if}\ \ u &gt; 0 \\
3\ \ \mathrm{else} \\
\end{matrix}\right.\]
</div>
</div>
<div class="paragraph">
<p>where \({u}\) is a continuous-time input with <code>valueReference</code> = <code>1</code> and \({y}\) is a continuous-time output with <code>valueReference</code> = <code>2</code>.</p>
</div>
<div class="paragraph">
<p>The definition of the model structure is then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ModelVariables&gt;
   &lt;Float64 name="u" valueReference= "1" causality="input" start="1"/&gt;
   &lt;Float64 name="y" valueReference= "2" causality="output"/&gt;
&lt;/ModelVariables&gt;
&lt;ModelStructure&gt;
  &lt;Output valueReference="2" dependencies="1" dependenciesKind="dependent"/&gt;
  &lt;InitialUnknown valueReference="2"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that \({y = c}\) where \({c}\) changes only during event mode (\({c = 2}\) or \({3\ }\) depending on relation \({u &gt; 0}\) that changes only at event mode).
Therefore <code>dependenciesKind</code> = <code>dependent</code> because it is not a linear relationship on \({u}\).</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_4">5.7.4. Example 4</h4>
<div class="paragraph">
<p>An FMU is defined by the following equations:</p>
</div>
<div class="stemblock">
<div class="content">
\[\frac{dx}{dt}=u, y=x\]
</div>
</div>
<div class="paragraph">
<p>where \({u}\) is a continuous-time input with <code>valueReference</code> = <code>1</code>, \({y}\) is a continuous-time output with <code>valueReference</code> = <code>2</code> and \({dxdt}\) is a continuous-time derivative with <code>valueReference</code> = <code>4</code>.</p>
</div>
<div class="paragraph">
<p>The definition of the model structure is then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;ModelVariables&gt;
   &lt;Float64 name="u" valueReference= "1" causality="input" start="0"/&gt;
   &lt;Float64 name="y" valueReference= "2" causality="output"/&gt;
   &lt;Float64 name="x" valueReference= "3"/&gt;
   &lt;Float64 name="dxdt" valueReference= "4"/&gt;
&lt;/ModelVariables&gt;
&lt;ModelStructure&gt;
  &lt;Output valueReference="2" dependencies="3" dependenciesKind="constant"/&gt;
  &lt;ContinuousStateDerivative valueReference="4" dependencies="1" dependenciesKind="constant"/&gt;
  &lt;InitialUnknown valueReference="2" dependencies="3"/&gt;
&lt;/ModelStructure&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_co_simulation_specific_issues">6. Co-Simulation Specific Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_early_return">6.1. Early Return</h3>
<div class="paragraph">
<p>Starting with FMI 3.0, co-simulation FMUs can optionally support early return from <code>fmi3DoStep</code> calls to allow more timely handling of internal events.</p>
</div>
<div class="paragraph">
<p>This capability can be used stand-alone, or in combination with <a href="#_event_handling_in_co_simulation">Event-Handling in Co-Simulation</a>, as described below.</p>
</div>
<div class="paragraph">
<p>An FMU indicates its early return capability through the <code>mightReturnEarlyFromDoStep</code> and <code>canReturnEarlyAfterIntermediateUpdate</code> capability flags in its <code>modelDescription.xml</code> file.
Here <code>mightReturnEarlyFromDoStep</code> indicates the FMUs capability to return early on its own volition, whereas <code>canReturnEarlyAfterIntermediateUpdate</code> additionally indicates the FMUs capability to be forced by the importer to return early during intermediate update callbacks.</p>
</div>
<div class="paragraph">
<p>An importer indicates that it wants to use this capability by passing in <code>fmi3True</code> for the <code>earlyReturnAllowed</code> argument in the call to <code>fmi3InstantiateCoSimulation</code>.</p>
</div>
<div class="paragraph">
<p>An FMU can then return early from a call to <code>fmi3DoStep</code>, i.e. prior to fully completing its step to the full communication step, by setting the <code>earlyReturn</code> argument to <code>fmi3True</code>, and <code>lastSuccesfulTime</code> to the exact time the FMU computed up to, prior to returning from <code>fmi3DoStep</code>.</p>
</div>
<div class="paragraph">
<p>This allows an FMU to e.g. signal an internal event has occurred that the importer should take note of.</p>
</div>
<div class="paragraph">
<p>Note that if the FMU is used without external event handling enabled, any events will still be handled completely internally, and the early return is just used to give the importer a chance to take note of the event.
If early return capability is used in conjunction with external event handling, as described in <a href="#_event_handling_in_co_simulation">Section 6.2</a> below, then events are not only signalled but also need to be handled by the importer if so indicated by the FMU.</p>
</div>
</div>
<div class="sect2">
<h3 id="_event_handling_in_co_simulation">6.2. Event-Handling in Co-Simulation</h3>
<div class="paragraph">
<p>Starting with FMI 3.0, co-simulation FMUs can optionally support external event-handling, i.e. notifying the co-simulation algorithm of the importer about events, which the importer then handles by putting the FMU into event mode, where event iteration can take place.
This is similar to the way model exchange has always supported external event handling.</p>
</div>
<div class="paragraph">
<p>An FMU indicates this capability through the <code>hasEventMode</code> capability flag in its <code>modelDescription.xml</code> file.
An importer indicates that it wants to use this capability by passing in <code>fmi3True</code> for the <code>eventModeUsed</code> argument in the call to <code>fmi3InstantiateCoSimulation</code>.</p>
</div>
<div class="paragraph">
<p>The FMU then indicates that event handling is needed by setting the <code>eventHandlingNeeded</code> argument to <code>fmi3True</code> in the call to <code>fmi3DoStep</code> prior to returning.</p>
</div>
<div class="paragraph">
<p>Note that this can interact with <a href="#_early_return">Early Return</a> in the following way:
If an FMU supports early return, and the importer has signaled support for early return (through <code>earlyReturnAllowed</code>), then if an event occurs prior to the end of the communication step, the FMU would return early with both <code>earlyReturn</code> and <code>eventHandlingNeeded</code> arguments set to <code>fmi3True</code>, and <code>lastSuccesfulTime</code> giving the exact time of the event.</p>
</div>
<div class="paragraph">
<p>If however an FMU either does not support early return, or is instantiated with <code>earlyReturnAllowed</code> set to <code>fmi3False</code>, then even if an event occurs prior to the end of the communication step, the FMU must continue to the end of the communication step.
It will indicate the event as usual through <code>eventHandlingNeeded</code> being set to <code>fmi3True</code>, and will have to expect the importer to enter event mode as usual.
However the exact point in time when the event occured will have already passed, and is not available to the importer.
This might require at least mitigative internal event handling by the FMU itself.</p>
</div>
<div class="paragraph">
<p>For this reason it is usually recommended to use event handling support and early return capabilities together, both for exporters and importers, as this will give the best event handling control.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_model_exchange_specific_issues">7. Model-Exchange Specific Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_completed_integrator_step_function">7.1. Completed Integrator Step Function</h3>
<div class="paragraph">
<p>Since the initial release, the FMI API provides a function of the FMU that the integrator is supposed to call at the end of every completed step.</p>
</div>
<div class="paragraph">
<p>However the exact semantics, capability flags, and rules when to call this function vary between all major releases of FMI:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In FMI 1.0 the function is called <code>fmiCompletedIntegratorStep</code> and the function must be called by the environment after every completed step of the integrator.</p>
</li>
<li>
<p>In FMI 2.0 the function is called <code>fmi2CompletedIntegratorStep</code> and it must be called at every completed step of an integrator&#8201;&#8212;&#8201;provided the capability flag <code>completedIntegratorStepNotNeeded</code> is not provided or false.</p>
</li>
<li>
<p>In FMI 3.0 the function is called <code>fmi3CompletedIntegratorStep</code> and it must be called after every completed step of the integrator&#8201;&#8212;&#8201;provided the capability flag <code>needsCompletedIntegratorStep</code> is true.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note especially that the name and logic of the capability flag controlling whether an importing implementation needs to call the function is changed between 2.0 and 3.0:
Whereas in 1.0 the function must be called unconditionally, in 2.0 the function must be called unless the FMU actively disables this through the <code>completedIntegratorStepNotNeeded</code> capability flag, and in 3.0 the function must only be called if the FMU actively requests this through the <code>needsCompletedIntegratorStep</code> capability flag.</p>
</div>
<div class="paragraph">
<p>Implementers migrating between releases or supporting new ones should take this into account.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scheduled_execution_specific_issues">8. Scheduled-Execution Specific Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_use_cases_for_scheduled_execution">8.1. Use-cases for Scheduled Execution</h3>
<div class="paragraph">
<p>The scheduled execution interface type is intended for use cases, where the ability to directly control the scheduling of internal time partitions of multiple FMUs from the outside is considered necessary.</p>
</div>
<div class="paragraph">
<p>Note that in cases where the actual direct control of the runtime of internal time partitions is not required, the use of clocked co-simulation or model exchange interface types may be more appropriate.</p>
</div>
</div>
<div class="sect2">
<h3 id="_priority_levels_of_clocks">8.2. Priority Levels of Clocks</h3>
<div class="paragraph">
<p>In scheduled execution clocks must be assigned priority information through the <code>priority</code> attribute on the clock variable.</p>
</div>
<div class="paragraph">
<p>A clock&#8217;s priority information is required to support the scheduled execution of several model partitions, especially in a preemptive scheduling regime.</p>
</div>
<div class="paragraph">
<p>The clock priorities are local to an FMU.
It is not possible for an exporting tool to know in advance the priorities of other FMUs that will be connected to an FMU in a simulation setup.
It is the responsibility of the importer to derive a computational order for the computation of two or more distinct FMUs based on the local FMU clock priorities and input-output relationships of connected FMUs.</p>
</div>
<div class="paragraph">
<p>For periodic clocks it is recommended to derive the priorities based on a rate-monotonic scheduling scheme (smallest period leads to highest priority, that is, has the smallest priority value).</p>
</div>
<div class="paragraph">
<p>Although the priority attribute is defined as 32-bit unsigned integer type, in case this is mapped by implementations directly to target platform priority levels, it is recommended to restrict the number of distinct priority levels for an FMU to the available priority levels on the target platform.
A common number of different priority levels is, e.g., 100 (0 to 99), as defined in Linux-based operating systems.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_of_preemptive_scheduling">8.3. Handling of Preemptive Scheduling</h3>
<div class="paragraph">
<p>To support safe preemptive scheduling of model partitions in scheduled execution, FMI 3.0 provides the callbacks <code>fmi3LockPreemptionCallback</code> and <code>fmi3UnlockPreemptionCallback</code> so that FMUs can guard critical sections of its code against preemption.</p>
</div>
<div class="paragraph">
<p>An FMU&#8217;s code has to be prepared to correctly handle preemption of</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fmi3ActivateModelPartition</code>,</p>
</li>
<li>
<p><code>fmi3Get{VariableType}</code>,</p>
</li>
<li>
<p><code>fmi3Set{VariableType}</code>,</p>
</li>
<li>
<p><code>fmi3GetClock</code>,</p>
</li>
<li>
<p>and <code>fmi3GetIntervalDecimal</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>among others.</p>
</div>
<div class="paragraph">
<p>In general this means that the FMU&#8217;s code has to secure access to its global states and variables wherever data inconsistencies due to potential preemptions are anticipated.</p>
</div>
<div class="paragraph">
<p>Note that in order to avoid data inconsistencies and safeguard predictable and deadlock-free behavior with <code>fmi3Get{VariableType}</code> and <code>fmi3Set{VariableType}</code> a unique assignment of variables to model partitions via its associated clock is strongly recommended.
If every variable is assigned uniquely to a model partition it is usually not necessary to use preemption locks in the context of <code>fmi3Get{VariableType}</code> and <code>fmi3Set{VariableType}</code>:</p>
</div>
<div class="paragraph">
<p>The following example illustrates why every variable should be assigned uniquely to one model partition via its associated clock:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>An output variable is changed by two different model partitions:</em><br>
The values returned by <code>fmi3Get{VariableType}</code> that is placed after <code>fmi3ActivateModelPartition</code> may return the values computed by the other model partition if that model partition has higher priority and preempted the execution meanwhile.</p>
</li>
<li>
<p><em>An input variable is used by two different model partitions:</em><br>
The variable values of a model partitions of lower priority may have been overwritten by a call to <code>fmi3Set{VariableType}</code> for a model partition of higher priority.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similarly, for <code>fmi3GetClock</code> the FMU has to ensure that the active state of an output clock is securely reset and cannot be observed twice for the same clock tick in case this call is preempted.</p>
</div>
<div class="paragraph">
<p>For <code>fmi3GetIntervalDecimal</code> the FMU has to ensure that the countdown clock&#8217;s interval qualifier is reset to <code>fmi3IntervalUnchanged</code> and cannot be observed twice for the same clock tick in case this call is preempted.</p>
</div>
<div class="paragraph">
<p>Depending on their implementation, <code>fmi3CallbackLockPreemption</code> and <code>fmi3CallbackUnlockPreemption</code> have a non-negligible overhead, as well as a strong impact on the scheduler and therefore their use should be as rare and short as possible.</p>
</div>
<div class="paragraph">
<p>In general, it is recommended to reduce dependencies between different model partitions of one FMU by design.
One may also consider if the code can be preempted by other parts of the same FMU:
E.g. a model partition cannot be interrupted if it is the only model partition or if it holds the highest priority.
Similarly, a model partition, while it might be interrupted, might not need to guard data accesses if it is the only model partition of the FMU, or the one with the highest priority.
In such cases no locks may be necessary.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_features">9. Advanced Features</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_partial_derivatives">9.1. Partial Derivatives</h3>
<div class="paragraph">
<p>FMI 3.0 provides optional access to partial derivatives for variables of an FMU.
Partial derivatives can be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in Newton algorithms to solve algebraic loops,</p>
</li>
<li>
<p>in implicit integration algorithms in Model Exchange,</p>
</li>
<li>
<p>in iterative Co-Simulation algorithms, and</p>
</li>
<li>
<p>in optimization algorithms.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To avoid expensive numeric approximations of these derivatives, FMI offers dedicated functions to retrieve partial derivatives for variables of an FMU:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fmi3GetDirectionalDerivative</code> to compute the directional derivatives \(\mathbf{v}_{\mathit{sensitivity}} = \mathbf{J} \cdot \mathbf{v}_{\mathit{seed}}\), and</p>
</li>
<li>
<p><code>fmi3GetAdjointDerivative</code> to calculate the adjoint derivatives \(\mathbf{\bar{v}}_{\mathit{sensitivity}}^T = \mathbf{\bar{v}}_{\mathit{seed}}^T \cdot \mathbf{J}\)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>with the Jacobian</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{J}
=
\begin{bmatrix}
\frac{\partial g_1}{\partial v_{\mathit{known},1}} &amp; \cdots &amp; \frac{\partial g_1}{\partial v_{\mathit{known},n}} \\
\vdots &amp; \ddots &amp; \vdots \\
\frac{\partial g_m}{\partial v_{\mathit{known},1}} &amp; \cdots &amp; \frac{\partial g_m}{\partial v_{\mathit{known},n}}
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>where \(\mathbf{v}_{\mathit{known}}\) are the \(n\) knowns, and \(\mathbf{g}\) are the \(m\) functions to calculate the \(m\) unknown variables \(\mathbf{v}_{\mathit{unknwon}}\) from the knowns.</p>
</div>
<div class="paragraph">
<p>The functions can be used to compute Jacobian-vector products or to construct the partial derivative matrices column-wise or row-wise by choosing the seed vector \(\mathbf{v}_{\mathit{seed}} \in \mathbb{R}^n\) or \(\mathbf{\bar{v}}_{\mathit{seed}} \in \mathbb{R}^m\), respectively, accordingly.</p>
</div>
<div class="paragraph">
<p>For information on the call signature see the FMI specification.</p>
</div>
<div class="sect3">
<h4 id="directionDerivatives">9.1.1. Directional Derivatives</h4>
<div class="paragraph">
<p>The function <code>fmi3GetDirectionalDerivative</code> computes the directional derivative</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{v}_{\mathit{sensitivity}} = \mathbf{J} \cdot \mathbf{v}_{\mathit{seed}}\]
</div>
</div>
<div class="paragraph">
<p>One can either retrieve the \(\mathit{i}\)-th column of the Jacobian by specifying the \(\mathit{i}\)-th unit vector \(\mathbf{e}_{\mathit{i}}\) as the seed vector \(\mathbf{v}_{\mathit{seed}}\), or compute a Jacobian-vector product \(\mathbf{Jv}\) by using \(\mathbf{v}\) as the seed vector \(\mathbf{v}_{\mathit{seed}}\). Therefore, the function can be utilized for the following purposes, among others:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Solving algebraic loops with a nonlinear solver requires matrix \({\frac{\partial \mathbf{g}}{\partial \mathbf{u}}}\).</p>
</li>
<li>
<p>Numerical integrators of stiff methods need matrix \({\frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\).</p>
</li>
<li>
<p>If the FMU is connected with other FMUs, the partial derivatives of the state derivatives and outputs with respect to the continuous states and the inputs are needed in order to compute the Jacobian for the system of the connected FMUs.</p>
</li>
<li>
<p>If the FMU shall be linearized, the same derivatives as in the previous item are needed.</p>
</li>
<li>
<p>If the FMU is used as the model for an extended Kalman filter, \({\frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\) and \({\frac{\partial \mathbf{g}}{\partial \mathbf{x}}}\) are needed.</p>
</li>
<li>
<p>If matrix-free linear solvers shall be used, Jacobian-vector products \({\mathbf{Jv}}\) are needed (e.g. as a user-supplied routine in CVODE <a href="#CVODE570">[CVODE570]</a>).</p>
</li>
</ul>
</div>
<div id="example-directional-derivatives" class="paragraph">
<p>Example 1:<br>
Assume an FMU has the output equations</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
y_1
\\
y_2
\end{bmatrix}
=
\begin{bmatrix}
g_1(x, u_1, u_3, u_4)
\\
g_2(x, u_1)
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>and this FMU is connected, so that \({y_1, u_1, u_3}\) appear in an algebraic loop.
Then the nonlinear solver needs a Jacobian and this Jacobian can be computed (without numerical differentiation) provided the partial derivative of \({y_1}\) with respect to \({u_1}\) and \({u_3}\) is available.
Depending on the environment where the FMUs are connected, these derivatives can be provided:</p>
</div>
<div class="paragraph">
<p>(a) with one wrapper function around function <code>fmi3GetDirectionalDerivative</code> to compute the directional derivatives with respect to these two variables (in other words, \({v_{\mathit{unknown}} = y_1}\), \({v_{\mathit{known}} = \left \{ u_1, u_3 \right \}}\)), and then the environment calls this wrapper function with \({v_{\mathit{seed}} = \left \{ 1, 0 \right \}}\) to compute the partial derivative with respect to \({u_1}\) and \({v_{\mathit{seed}} = \left \{ 0, 1 \right \}}\) to compute the partial derivative with respect to \({u_3}\), or</p>
</div>
<div class="paragraph">
<p>(b) with two direct function calls of <code>fmi3GetDirectionalDerivative</code> (in other words, \({v_{\mathit{unknown}} = y_1, v_{\mathit{known}} = u_1, v_{\mathit{seed}} = 1}\); and \({v_{\mathit{unknown}} = y_1, v_{\mathit{known}} = u_3, v_{\mathit{seed}} = 1}\)).</p>
</div>
<div class="paragraph">
<p>Note that a direct implementation of this function with analytic derivatives:</p>
</div>
<div class="paragraph">
<p>(a) Provides the directional derivative for all input variables; so in the <a href="#example-directional-derivatives">above example</a>: \({\Delta y_1 = \frac{\partial g_1}{\partial x} \cdot \Delta x + \frac{\partial g_1}{\partial u_1} \cdot \Delta u_1 + \frac{\partial g_1}{\partial u_3} \cdot \Delta u_3 + \frac{\partial g_1}{\partial u_4} \cdot \Delta u_4}\)</p>
</div>
<div class="paragraph">
<p>(b) Initializes all seed-values to zero; so in the <a href="#example-directional-derivatives">above example</a>: \({\Delta x = \Delta u_1 = \Delta u_3 = \Delta u_4 = 0}\)</p>
</div>
<div class="paragraph">
<p>(c) Computes the directional derivative with the seed-values provided in the function arguments; so in the <a href="#example-directional-derivatives">above example</a>: \({v_{\mathit{sensitivity}} = \Delta y_1 (\Delta x = 0, \Delta u_1 = 1, \Delta u_3 = 0, \Delta u_4 = 0)}\)] and \({v_{\mathit{sensitivity}} = \Delta y_1 (\Delta x = 0, \Delta u_1 = 0, \Delta u_3 = 1, \Delta u_4 = 0)}\)]</p>
</div>
<div class="paragraph">
<p>Example 2:<br>
If a dense matrix shall be computed, the columns of the matrix can be easily constructed by successive calls of <code>fmi3GetDirectionalDerivative</code>.
For example, constructing the system Jacobian \({\mathbf{A} = \frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\) as dense matrix can be performed in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">    //   c[]      column vector

    // set time, states and inputs
    fmi3SetTime(S, time);
    fmi3SetContinuousStates(S, x, nx);
    // fmi3Set{VariableType}(S, ...);

    // if required at this step, compute the Jacobian as a dense matrix
    for (i = 0; i &lt; nx; i++) {
        // construct the Jacobian matrix column wise
        fmi3GetDirectionalDerivative(S, vr_dx, nx, &amp;vr_x[i], 1, &amp;dk, 1, c, nx);
        for (j = 0; j &lt; nx; j++) {
            J[j][i] = c[j];
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the sparsity of a matrix shall be taken into account, then the matrix can be constructed in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The incidence information of the matrix (whether an element is zero or not zero) is extracted from the XML file from element <code>ModelStructure</code>.</p>
</li>
<li>
<p>A so called graph coloring algorithm is employed to determine the columns of the matrix that can be computed by one call of <code>fmi3GetDirectionalDerivative</code>.</p>
</li>
<li>
<p>For the columns determined in (2), one call to <code>fmi3GetDirectionalDerivative</code> is made.
After each such call, the elements of the resulting directional derivative vector are copied into their correct locations of the partial derivative matrix.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More details and implementational notes are available from <a href="#ABL12">[ABL12]</a>.</p>
</div>
<div class="paragraph">
<p>Example 3:<br>
Directional derivatives for higher dimension variables are almost treated in the same way.
Consider, for example, an FMU which calculates its output \({Y}\) by multiplying its 2x2 input \({U}\) with a 3x2 constant gain \({K}\), with</p>
</div>
<div class="stemblock">
<div class="content">
\[K=
\begin{bmatrix}
a, b
\\
c, d
\\
e, f
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>The output \({Y=K U}\) is a matrix of size 3x2.
The directional derivative of an output element \({Y(i,j)}\) with respect to the input \({U}\) and the seed \({\Delta U}\) is:</p>
</div>
<div class="stemblock">
<div class="content">
\[\Delta Y(i,j) =
\frac{\partial Y(i,j)}{\partial U(1,1)} \cdot \Delta U(1,1) +
\frac{\partial Y(i,j)}{\partial U(1,2)} \cdot \Delta U(1,2) +
\frac{\partial Y(i,j)}{\partial U(2,1)} \cdot \Delta U(2,1) +
\frac{\partial Y(i,j)}{\partial U(2,2)} \cdot \Delta U(2,2)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[\Delta \mathbf{Y} =
\begin{bmatrix}
a \Delta U(1,1)+b \Delta U(2,1), a \Delta U(1,2)+ b \Delta U(2,2)
\\
c \Delta U(1,1)+d \Delta U(2,1), c \Delta U(1,2)+ d \Delta U(2,2)
\\
e \Delta U(1,1)+f \Delta U(2,1), e \Delta U(1,2)+ f \Delta U(2,2)
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>To get the directional derivative of \({Y}\) with respect to \({U(2,1)}\) the command <code>fmi3GetDirectionalDerivative(m, vr_Y, 1, vr_U, 1, {0.0, 0.0, 1.0, 0.0}, 4, dd, 6)</code> can be used where <code>vr_Y</code> and <code>vr_U</code> are references of the variable \({Y}\) and \({U}\), respectively.
Note that in order to get the directional derivative of \({Y}\) with respect to \({U(2,1)}\), the seed value <code>{0, 0, 1.0, 0}</code> has been used.
The retrieved directional derivative <code>dd</code> is stored in a matrix of size 3x2, so <code>nSensitivity</code> is 6.</p>
</div>
</div>
<div class="sect3">
<h4 id="adjointDerivatives">9.1.2. Adjoint Derivatives</h4>
<div class="paragraph">
<p>The function <code>fmi3GetAdjointDerivative</code> computes the adjoint derivative</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{\bar{v}}_{\mathit{sensitivity}}^T = \mathbf{\bar{v}}_{\mathit{seed}}^T \cdot \mathbf{J} \quad \text{or} \quad \mathbf{\bar{v}}_{\mathit{sensitivity}} = \mathbf{J}^T \cdot \mathbf{\bar{v}}_{\mathit{seed}}\]
</div>
</div>
<div class="paragraph">
<p>One can either retrieve the \(\mathit{i}\)-th row of the Jacobian by specifying the \(\mathit{i}\)-th unit vector \(\mathbf{e}_{\mathit{i}}\) as the seed vector \(\mathbf{\bar{v}}_{\mathit{seed}}\), or compute a vector-Jacobian product \(\mathbf{v}^T\mathbf{J}\) by using \(\mathbf{v}\) as the seed vector \(\mathbf{\bar{v}}_{\mathit{seed}}\).</p>
</div>
<div class="paragraph">
<p>Adjoint derivatives are beneficial in several contexts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in artificial intelligence (AI) frameworks the adjoint derivatives are called "vector gradient products" (VJPs). There adjoint derivatives are used in the backpropagation process to perform gradient-based optimization of parameters using reverse mode automatic differentiation (AD), see, e.g., <a href="#BPRS15">[BPRS15]</a>.</p>
</li>
<li>
<p>in parameter estimation (see <a href="#BKF17">[BKF17]</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Typically, reverse mode automatic differentiation (AD) is more efficient for these use cases than forward mode AD because the number of knowns is much higher than the number of unknowns (\(\mathit{n} \gg \mathit{m}\)), as explained in the cited references. If the full Jacobian is needed and the number of knowns and unknowns are somewhat equal (\(\mathit{m} \approx \mathit{n}\)) or small, the column-wise construct using <code>fmi3GetDirectionalDerivative</code> is generally more efficient.</p>
</div>
<div class="paragraph">
<p>Example:<br>
Assume an FMU has the output equations</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
y_1
\\
y_2
\end{bmatrix}
=
\begin{bmatrix}
h_1(u_1, u_2)
\\
h_2(u_1, u_2)
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>and \(\left( w_1,  w_2 \right)^T \cdot \mathbf{ \frac{\partial h}{\partial u} }\) for some vector \(\left( w_1,  w_2 \right)^T\) is needed.
Then one can get this with one function call of <code>fmi3GetAdjointDerivative</code> (with arguments \(\mathbf{v}_{\mathit{unknown}} = \text{valueReferences of} \left \{ y_1, y_2 \right \}\), \(\mathbf{v}_{\mathit{known}} = \text{valueReferences of} \left \{ u_1, u_2 \right \}\),  \(\mathbf{\bar{v}}_{\mathit{seed}} = \left( w_1, w_2 \right)^T\)), while with <code>fmi3GetDirectionalDerivative</code> at least two calls would be necessary to first construct the Jacobian column-wise and then multiplying from the right with \(\left( w_1,  w_2 \right)^T\).</p>
</div>
<div class="paragraph">
<p>If a dense matrix shall be computed, the rows of the matrix can be easily constructed by successive calls of <code>fmi3GetAdjointDerivative</code>.
For example, constructing the system Jacobian \({\mathbf{A} = \frac{\partial \mathbf{f}}{\partial \mathbf{x}}}\) as a dense matrix can be performed in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C hljs" data-lang="C">    for (i = 0; i &lt; nx; i++) {
        // construct the Jacobian matrix column wise
        fmi3GetAdjointDerivative(S, &amp;vr_dx[i], 1, vr_x, nx, &amp;dk, 1, &amp;J[i][0], nx);
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="ISO8601-1"></a>[ISO8601-1] International Organization for Standardization: <strong>ISO 8601-1:2019: Date and time&#8201;&#8212;&#8201;Representation for information interchange&#8201;&#8212;&#8201;Part 1: Basic rules</strong>. February 2019. <a href="https://www.iso.org/standard/70907.html" class="bare">https://www.iso.org/standard/70907.html</a></p>
</li>
<li>
<p><a id="RFC2119"></a>[RFC2119] Bradner, S.: <strong>Key words for use in RFCs to Indicate Requirement Levels</strong>. RFC 2119, March 1997. <a href="https://www.ietf.org/rfc/rfc2119.txt" class="bare">https://www.ietf.org/rfc/rfc2119.txt</a></p>
</li>
<li>
<p><a id="RFC5322"></a>[RFC5322] Resnick, P., Ed.: <strong>Internet Message Format</strong>. RFC 5322, October 2008. <a href="https://www.ietf.org/rfc/rfc5322.txt" class="bare">https://www.ietf.org/rfc/rfc5322.txt</a></p>
</li>
<li>
<p><a id="SEMVER200"></a>[SEMVER200] Preston-Werner, T.: <strong>Semantic Versioning 2.0.0</strong>. <a href="https://semver.org/spec/v2.0.0.html" class="bare">https://semver.org/spec/v2.0.0.html</a></p>
</li>
<li>
<p><a id="SSP10"></a>[SSP10] Modelica Association: <strong>System Structure and Parameterization 1.0</strong>. March 2019. <a href="https://ssp-standard.org/publications/SSP10/SystemStructureAndParameterization10.pdf" class="bare">https://ssp-standard.org/publications/SSP10/SystemStructureAndParameterization10.pdf</a></p>
</li>
<li>
<p><a id="CVODE570"></a>[CVODE570]  Hindmarsh A., Serban R., Balos C., Gardner D., Reynolds D., Woodward C.: <strong>User Documentation for CVODE v5.7.0</strong>. February 2021, p. 85ff. <a href="https://computing.llnl.gov/sites/default/files/cv_guide-5.7.0.pdf" class="bare">https://computing.llnl.gov/sites/default/files/cv_guide-5.7.0.pdf</a></p>
</li>
<li>
<p><a id="ABL12"></a>[ABL12] &#197;kesson J., Braun W., Lindholm P., and Bachmann B. (2012): <strong>Generation of Sparse Jacobians for the Functional Mockup Interface 2.0</strong>. 9th International Modelica Conference, Munich, 2012. <a href="http://www.ep.liu.se/ecp/076/018/ecp12076018.pdf" class="bare">http://www.ep.liu.se/ecp/076/018/ecp12076018.pdf</a></p>
</li>
<li>
<p><a id="BPRS15"></a>[BPRS15] Atilim Gunes Baydin, Barak A. Pearlmutter, Alexey Andreyevich Radul, Jeffrey Mark Siskind (2015): <strong>Automatic differentiation in machine learning: a survey</strong>. <a href="https://www.jmlr.org/papers/volume18/17-468/17-468.pdf" class="bare">https://www.jmlr.org/papers/volume18/17-468/17-468.pdf</a></p>
</li>
<li>
<p><a id="BKF17"></a>[BKF17] Braun W., Kulshreshtha K., Franke R., Walther A., Bachmann B. (2017): <strong>Towards Adjoint and Directional Derivatives in FMI utilizing ADOL-C within OpenModelica</strong>. 12th International Modelica Conference, Prague, 2017. <a href="https://2017.international.conference.modelica.org/proceedings/html/submissions/ecp17132363_BraunKulshreshthaFrankeBachmannWalther.pdf" class="bare">https://2017.international.conference.modelica.org/proceedings/html/submissions/ecp17132363_BraunKulshreshthaFrankeBachmannWalther.pdf</a></p>
</li>
<li>
<p><a id="SMARTSEV3"></a>[SMARTSEV3] prostep ivip: <strong>SmartSE Recommendation 2022 PSI 11 V3.0</strong>. December 2022. <a href="https://www.prostep.org/fileadmin/downloads/PSI_11_V3_SmartSE_Rec_and_Part_A-I.zip" class="bare">https://www.prostep.org/fileadmin/downloads/PSI_11_V3_SmartSE_Rec_and_Part_A-I.zip</a></p>
</li>
<li>
<p><a id="FMUCC"></a>[FMUCC] Modelica Association: <strong>FMU Compliance Checker</strong>. <a href="https://www.fmi-standard.org/downloads" class="bare">https://www.fmi-standard.org/downloads</a></p>
</li>
<li>
<p><a id="RefFMUs"></a>[RefFMUs] Modelica Association: <strong>Reference FMUs</strong>. <a href="https://github.com/modelica/Reference-FMUs/" class="bare">https://github.com/modelica/Reference-FMUs/</a></p>
</li>
<li>
<p><a id="VDMCheck"></a>[VDMCheck] INTO-CPS Association: <strong>FMI-VDM-Model</strong>. <a href="https://github.com/INTO-CPS-Association/FMI-VDM-Model" class="bare">https://github.com/INTO-CPS-Association/FMI-VDM-Model</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>